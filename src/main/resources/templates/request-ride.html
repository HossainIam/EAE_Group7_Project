<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Request a Ride</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body>
    <div class="app">
      <h2>Request a Ride</h2>

      <form id="requestRideForm">
        <input
          id="fromLocation"
          name="fromLocation"
          placeholder="From"
          required
        />
        <input id="toLocation" name="toLocation" placeholder="To" required />

        <label>Earliest Departure Time</label>
        <input type="datetime-local" name="earliestDepartureTime" required />

        <label>How many passengers?</label>
        <input
          type="number"
          name="passengerCount"
          min="1"
          value="1"
          required
        />

        <div id="routeInfo" style="margin-top: 8px; font-weight: 600;"></div>

        <button type="submit">Post Request</button>

        <div class="info" style="margin-top: 10px;">
          <a href="/rides/search">Back</a>
        </div>
      </form>

      <!-- Map -->
      <div id="map" style="height: 360px; width: 100%; margin-top: 16px;"></div>

      <pre id="out"></pre>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      document
        .getElementById("requestRideForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = new FormData(e.target);

          const userId = localStorage.getItem("userId");
          if (!userId) {
            document.getElementById("out").textContent = "Please login again.";
            window.location.href = "/login";
            return;
          }

          const payload = {
            passengerId: Number(userId),
            fromLocation: (form.get("fromLocation") || "").trim(),
            toLocation: (form.get("toLocation") || "").trim(),
            earliestDepartureTime: form.get("earliestDepartureTime"),
            passengerCount: Number(form.get("passengerCount")),
          };

          const res = await fetch("/ride-requests", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            window.location.href = "/rides/search";
          } else {
            document.getElementById("out").textContent = await res.text();
          }
        });
    </script>

    <script>
      const map = L.map("map").setView([48.137, 11.575], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      let routeLine = null;

      async function tryRoute() {
        const from = document.getElementById("fromLocation").value.trim();
        const to = document.getElementById("toLocation").value.trim();
        if (!from || !to) return;

        const fromRes = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            from
          )}`
        );
        const toRes = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            to
          )}`
        );

        const fromData = await fromRes.json();
        const toData = await toRes.json();
        if (!fromData.length || !toData.length) return;

        const fromLat = fromData[0].lat;
        const fromLng = fromData[0].lon;
        const toLat = toData[0].lat;
        const toLng = toData[0].lon;

        const routeRes = await fetch(
          `https://router.project-osrm.org/route/v1/driving/${fromLng},${fromLat};${toLng},${toLat}?overview=full&geometries=geojson`
        );

        const routeData = await routeRes.json();
        if (!routeData.routes || !routeData.routes.length) return;

        const coords = routeData.routes[0].geometry.coordinates.map((c) => [
          c[1],
          c[0],
        ]);
        const distanceKm = routeData.routes[0].distance / 1000;

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords).addTo(map);
        map.fitBounds(routeLine.getBounds());

        document.getElementById(
          "routeInfo"
        ).textContent = `Distance: ${distanceKm.toFixed(1)} km`;
      }

      document.getElementById("fromLocation").addEventListener("blur", tryRoute);
      document.getElementById("toLocation").addEventListener("blur", tryRoute);
    </script>
  </body>
</html>
