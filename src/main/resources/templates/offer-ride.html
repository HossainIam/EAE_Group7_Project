<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Offer a Ride</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="/style.css?v=123" />
  </head>

  <body>
    <div class="app">
      <h2>Offer a Ride</h2>

      <form id="offerRideForm">
        <input
          id="fromLocation"
          name="fromLocation"
          placeholder="From"
          required
        />
        <input id="toLocation" name="toLocation" placeholder="To" required />

        <label>Departure Time</label>
        <input type="datetime-local" name="departureTime" required />

        <label>Available Seats</label>
        <input type="number" name="availableSeats" min="1" required />

        <label>Fuel consumption (L/100km)</label>
        <input type="number" id="consumption" step="0.1" min="0" value="7" />

        <label>Fuel price (€/L)</label>
        <input type="number" id="fuelPrice" step="0.01" min="0" value="1.80" />

        <label>Total Fuel Cost (€)</label>
        <input
          type="number"
          id="totalFuelCost"
          name="totalFuelCost"
          step="0.01"
          min="0"
          required
        />

        <div id="routeInfo" class="info" style="margin-top: 8px;"></div>
        <div id="costBreakdown" style="margin-top: 8px; font-weight: 600;"></div>

        <p class="info" style="margin-top: 6px;">
          Note: A €1 platform maintenance fee is charged when posting a ride.
        </p>

        <button type="submit">Post Ride</button>

        <div class="info" style="margin-top: 10px;">
          <a href="/home">Back</a>
        </div>
      </form>

      <!-- Map + route info (ONLY ONCE) -->
      <div id="map" style="height: 360px; width: 100%; margin-top: 16px;"></div>

      <pre id="out"></pre>
    </div>

    <!-- Leaflet JS (load after DOM) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      document
        .getElementById("offerRideForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = new FormData(e.target);

          const userId = localStorage.getItem("userId");
          if (!userId) {
            document.getElementById("out").textContent = "Please login again.";
            window.location.href = "/login";
            return;
          }

          const payload = {
            driverId: Number(userId),
            fromLocation: (form.get("fromLocation") || "").trim(),
            toLocation: (form.get("toLocation") || "").trim(),
            departureTime: form.get("departureTime"),
            availableSeats: Number(form.get("availableSeats")),
            totalFuelCost: Number(form.get("totalFuelCost")),
          };

          const res = await fetch("/rides", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            window.location.href = "/rides/search";
          } else {
            document.getElementById("out").textContent = await res.text();
          }
        });
    </script>

    <script>
      const map = L.map("map").setView([48.137, 11.575], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      let routeLine = null;

      function updateCostBreakdown(totalFuelCost) {
        const seats = Number(
          document.querySelector('input[name="availableSeats"]').value || 0
        );
        const participants = 1 + seats; // driver + all available seats (estimate)
        const platformFee = 1;

        const fuelPerPerson = totalFuelCost / participants;
        const totalPerPerson = fuelPerPerson + platformFee;

        document.getElementById("costBreakdown").textContent =
          `Total per person (${participants} people): €${totalPerPerson.toFixed(
            2
          )} ` +
          `(Fuel: €${fuelPerPerson.toFixed(2)} + Platform fee: €1.00)`;
      }

      async function tryRoute() {
        const from = document.getElementById("fromLocation").value.trim();
        const to = document.getElementById("toLocation").value.trim();
        if (!from || !to) return;

        const fromRes = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            from
          )}`
        );
        const toRes = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            to
          )}`
        );

        const fromData = await fromRes.json();
        const toData = await toRes.json();
        if (!fromData.length || !toData.length) return;

        const fromLat = fromData[0].lat;
        const fromLng = fromData[0].lon;
        const toLat = toData[0].lat;
        const toLng = toData[0].lon;

        const routeRes = await fetch(
          `https://router.project-osrm.org/route/v1/driving/${fromLng},${fromLat};${toLng},${toLat}?overview=full&geometries=geojson`
        );

        const routeData = await routeRes.json();
        const coords = routeData.routes[0].geometry.coordinates.map((c) => [
          c[1],
          c[0],
        ]);
        const distanceKm = routeData.routes[0].distance / 1000;

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords).addTo(map);
        map.fitBounds(routeLine.getBounds());

        const consumption = Number(
          document.getElementById("consumption").value || 0
        );
        const fuelPrice = Number(
          document.getElementById("fuelPrice").value || 0
        );
        const totalFuelCost = (distanceKm / 100) * consumption * fuelPrice;

        document.getElementById("routeInfo").textContent =
          `Distance: ${distanceKm.toFixed(
            1
          )} km | Total fuel cost: €${totalFuelCost.toFixed(2)}`;

        document.getElementById("totalFuelCost").value =
          totalFuelCost.toFixed(2);

        // NEW: show total per person
        updateCostBreakdown(totalFuelCost);
      }

      // auto update
      document.getElementById("fromLocation").addEventListener("blur", tryRoute);
      document.getElementById("toLocation").addEventListener("blur", tryRoute);
      document.getElementById("consumption").addEventListener("input", tryRoute);
      document.getElementById("fuelPrice").addEventListener("input", tryRoute);

      document
        .querySelector('input[name="availableSeats"]')
        .addEventListener("input", () => {
          const totalFuelCost = Number(
            document.getElementById("totalFuelCost").value || 0
          );
          if (totalFuelCost > 0) updateCostBreakdown(totalFuelCost);
        });
    </script>
  </body>
</html>
